//CODE_CHANGES = getGitChanges()
pipeline {
    agent any
    tools {
        maven 'MavenDefault'
    }
    environment {
        NEW_VERSION = '1.6.0'
        BRANCH_NAME = 'feature'
        PATH = "E:/apache-maven-3.6.3-bin/apache-maven-3.6.3/bin:${env.PATH}"
    }
    parameters {
        string(name: 'Unit Test', defaultValue: 'Test stage has invoked', description: 'Test stage is running')
        choice(name: 'jdkVersion', choices: ['1.8', '1.9', '1.12'], description: 'Building with this version')
        booleanParam(name: 'executeTests', defaultValue: true, description: 'Execute tests with this parameter')
    }
    stages {
        stage ("Log Jenkins with Maven, Git and Java info") {
            steps {
                bat 'mvn -version'
                bat 'java -version'
                bat 'git --version'
            }
        }
        stage ("Build") {
            when {
                expression {
                    params.executeTests
                    ${env.BRANCH_NAME} == 'feature'
                            //&& CODE_CHANGES == true
                }
            }
            steps {
                echo 'Building the application...'
                echo "Building with version ${env.NEW_VERSION}"
                //git 'https://github.com/shriramk0706/UnitTestRepo.git'
                //withMaven(maven : 'apache-maven-3.6.3')
                sh "mvn -Dmaven.test.failure.ignore=true test package"
            }
        }
        stage ("Test") {
            when {
                expression {
                    params.executeTests
                    ${env.BRANCH_NAME} == 'feature'
                            //&& CODE_CHANGES == true
                }
            }
            steps {
                echo 'Test is running...'
                sh "mvn test install"
            }
        }
    }
}
